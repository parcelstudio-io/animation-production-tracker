# Railway Database Sync Setup Guide

## Overview
This guide sets up `animation-tracker-db` in Railway with real-time bidirectional sync to the local server.

## ðŸŽ¯ Sync Flow Architecture

```
User Action (Railway App) â†“
        â†“
Railway PostgreSQL Database â†“
        â†“ (immediate notification)
Local Server (via ngrok) â†“
        â†“
production_summary.xlsx (Excel File)
        â†“ (duration analysis)
Animation Folders (video/image files)
```

## 1. Railway Database Setup

### Step 1: Add PostgreSQL Service
1. Go to [Railway Dashboard](https://railway.app/)
2. Open your `animation-tracker-production` project
3. Click **"+ New Service"**
4. Select **"PostgreSQL"**
5. Railway automatically creates the database with these variables:
   - `DATABASE_URL` - Complete connection string
   - `PGHOST`, `PGPORT`, `PGDATABASE`, `PGUSER`, `PGPASSWORD`

### Step 2: Set Environment Variables
In Railway dashboard, add these variables:

```bash
# Application
NODE_ENV=production
PORT=3000

# Local Server Sync (Critical for Excel sync)
LOCAL_SERVER_URL=https://nonconfirming-kaiden-nonoily.ngrok-free.dev
LOCAL_SERVER_API_KEY=ParcelStudio2025

# Database Sync Control
ENABLE_CLOUD_SYNC=true
ENABLE_LOCAL_EXCEL=false
AUTO_BACKUP_EXCEL=false

# Security
WEBHOOK_SECRET=ParcelStudio2025
```

### Step 3: Run Database Migration
```bash
# Deploy the app first, then run migration
railway run npm run migrate

# Or manually create tables via Railway CLI
railway connect
# Then run the SQL from database/schema.sql
```

## 2. Database Schema

The `animation-tracker-db` will have these tables:

### `production_summary` Table
```sql
CREATE TABLE production_summary (
    id SERIAL PRIMARY KEY,
    animator VARCHAR(100) NOT NULL,
    project_type VARCHAR(20) NOT NULL,
    episode_title VARCHAR(200) NOT NULL,
    scene VARCHAR(50) NOT NULL,
    shot VARCHAR(50) NOT NULL,
    week_yyyymmdd VARCHAR(8) NOT NULL,
    status VARCHAR(20) NOT NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### `sync_log` Table
```sql
CREATE TABLE sync_log (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(50) NOT NULL,
    action VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    error_message TEXT,
    local_record_id INTEGER,
    railway_record_id INTEGER,
    data_snapshot JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 3. Real-time Sync Configuration

### Railway â†’ Local Sync Flow

**When users make changes on Railway app:**

1. **User Action** â†’ Railway database updated
2. **Railway Server** â†’ Calls `notifyLocalServer(action, data)`
3. **Local Server** â†’ Receives notification at `/api/sync/from-railway`
4. **Local Server** â†’ Updates `production_summary.xlsx`
5. **Local Server** â†’ Runs duration analysis on video/image files

### Local â†’ Railway Sync Flow

**When local Excel file changes:**

1. **Excel File** â†’ Modified locally
2. **Railway App** â†’ User visits site, triggers `/api/production-data/with-local-sync`
3. **Railway Server** â†’ Calls `fetchFromLocalServer()`
4. **Local Server** â†’ Returns Excel data via `/api/sync/excel-data`
5. **Railway Database** â†’ Replaced with Excel data (Excel is authoritative)

## 4. Testing the Setup

### Test Database Connection
```bash
curl https://animation-tracker-production.up.railway.app/api/db-test
```

Expected response:
```json
{
  "success": true,
  "message": "Database connected successfully",
  "timestamp": "2026-01-03T...",
  "database_version": "PostgreSQL 15.x...",
  "production_table_exists": true,
  "database_name": "animation-tracker-db"
}
```

### Test Local Server Connection
```bash
curl https://animation-tracker-production.up.railway.app/api/sync/status
```

Expected response:
```json
{
  "databaseEnabled": true,
  "cloudSyncEnabled": true,
  "environment": "production"
}
```

### Test Excel Sync
1. Visit: `https://animation-tracker-production.up.railway.app`
2. Check browser console for: `âœ… Excel sync successful`
3. Add a new production entry
4. Check local server logs for: `âœ… Local server notified of Railway entry`

## 5. Monitoring Sync Operations

### Key Log Messages to Watch:

**Railway App Logs:**
```
ðŸš€ CRITICAL: Notifying local server of Railway database change...
âœ… Local server notified of new Railway entry
ðŸ“¥ Found 5 records in local Excel file
âœ… Railway database updated from Excel file
```

**Local Server Logs:**
```
ðŸ“¤ Railway app requesting Excel data export...
âœ… Excel data exported to Railway: 5 records
ðŸ”„ Starting real-time bidirectional sync for create...
âš¡ Real-time bidirectional sync completed in 1250ms
```

## 6. Environment Variable Summary

### Railway Environment Variables (Required)
```bash
DATABASE_URL=postgresql://...              # Auto-generated by Railway
LOCAL_SERVER_URL=https://...ngrok-free.dev # Your ngrok URL
LOCAL_SERVER_API_KEY=ParcelStudio2025      # Sync authentication
NODE_ENV=production                        # Environment
PORT=3000                                  # Railway port
ENABLE_CLOUD_SYNC=true                     # Enable database
```

### Local Server Environment Variables (Required)
```bash
PORT=3001                                  # Local server port
RAILWAY_APP_URL=https://...railway.app     # Railway app URL
API_SECRET=ParcelStudio2025               # API authentication
ENABLE_AUTO_SYNC=false                    # Optional background sync
```

## 7. Troubleshooting

### Common Issues:

1. **"Excel file not available"**
   - Check `LOCAL_SERVER_URL` in Railway env vars
   - Verify ngrok tunnel is running: `ngrok status`
   - Test endpoint: `curl https://...ngrok-free.dev/api/sync/excel-data`

2. **"Database connection failed"**
   - Check `DATABASE_URL` is set in Railway
   - Verify PostgreSQL service is running
   - Check logs: `railway logs`

3. **"Sync not working"**
   - Check both Railway and local server logs
   - Verify API keys match on both sides
   - Test manual sync: visit Railway app page

### Debug Commands:
```bash
# Railway logs
railway logs

# Test Railway database
curl https://animation-tracker-production.up.railway.app/api/db-test

# Test local server
curl https://nonconfirming-kaiden-nonoily.ngrok-free.dev/api/health

# Test Excel endpoint
curl https://nonconfirming-kaiden-nonoily.ngrok-free.dev/api/sync/excel-data
```

## 8. Success Indicators âœ…

You'll know everything is working when:

1. **Railway Database**: `/api/db-test` returns success
2. **Local Server**: Accessible via ngrok URL
3. **Excel Sync**: Railway app shows "Excel sync successful" 
4. **Real-time Updates**: Changes appear instantly on both ends
5. **Duration Analysis**: FFmpeg processes animation files automatically

The system ensures that:
- Excel file remains the authoritative source of truth
- Railway database stays in sync with Excel data
- All changes trigger immediate bidirectional sync
- Animation durations are analyzed automatically